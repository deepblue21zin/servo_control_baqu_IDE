# 서보 모터 위치 제어 시스템 - 전체 코드 구조

## 프로젝트 개요
**MCU:** STM32F429ZI (Cortex-M4, 180MHz)
**목적:** 브러시리스 서보 모터(XDL-L7SA004BAA) ±45° 정밀 위치 제어

---

## 1. 하드웨어 추상화 계층 (HAL) - CubeMX 자동 생성

| 파일 | 역할 | 핵심 동작 | 주요 함수 |
|------|------|----------|----------|
| `gpio.c` / `gpio.h` | GPIO 핀 초기화 | 모든 GPIO 포트 클럭 활성화, LED/릴레이/이더넷/USB 핀 설정 | `MX_GPIO_Init()` |
| `adc.c` / `adc.h` | ADC1 초기화 | PA4(CH4) 12비트 ADC 설정, 포텐셔미터 입력용 | `MX_ADC1_Init()`, `HAL_ADC_MspInit()` |
| `tim.c` / `tim.h` | 타이머 초기화 | TIM1: PWM 출력(PE9/PE11), TIM2: 엔코더 입력(PA0/PA1) | `MX_TIM1_Init()`, `MX_TIM2_Init()` |
| `usart.c` / `usart.h` | UART 초기화 | USART1(PA9/10), USART3(PD8/9) 115200bps 설정 | `MX_USART1_UART_Init()`, `MX_USART3_UART_Init()` |
| `stm32f4xx_it.c` | 인터럽트 핸들러 | SysTick(1ms), HardFault, NMI 등 예외 처리 | `SysTick_Handler()`, `HardFault_Handler()` |
| `stm32f4xx_hal_msp.c` | MSP 초기화 | SYSCFG/PWR 클럭 활성화 | `HAL_MspInit()` |
| `system_stm32f4xx.c` | 시스템 초기화 | FPU 설정, 벡터 테이블 설정, 클럭 업데이트 | `SystemInit()`, `SystemCoreClockUpdate()` |

---

## 2. 애플리케이션 계층 - 사용자 작성

| 파일 | 역할 | 핵심 동작 | 주요 함수 |
|------|------|----------|----------|
| `main.c` / `main.h` | **메인 진입점** | 시스템 클럭 180MHz 설정, 주변장치 초기화, 메인 루프에서 서보 Forward/Reverse 데모 실행 | `main()`, `SystemClock_Config()`, `__io_putchar()` |
| `position_control.c` / `position_control.h` | **PID 위치 제어** | Kp=500, Ki=5, Kd=20 PID 알고리즘, 오차 계산 → 펄스 주파수 출력, 안정성 판단(0.5° 이하 100ms), 안전 체크 | `PositionControl_Init()`, `PositionControl_Update()`, `PositionControl_SetTarget()`, `PID_Calculate()` |
| `pulse_control.c` / `pulse_control.h` | **PWM 펄스 출력** | TIM1_CH1으로 펄스 신호, TIM1_CH2로 방향 신호 출력, 1ms 딜레이 방식으로 펄스 생성 | `pulse_forward()`, `pulse_reverse()`, `PulseControl_SetFrequency()`, `PulseControl_Stop()` |
| `encoder_reader.c` / `encoder_reader.h` | **엔코더 읽기** | TIM2 쿼드러처 모드로 12000PPR×4=48000 카운트/회전, 0.0075°/카운트 분해능 | `EncoderReader_Init()`, `EncoderReader_GetAngleDeg()`, `EncoderReader_GetCount()`, `EncoderReader_Reset()` |
| `relay_control.c` / `relay_control.h` | **릴레이 제어** | PD14(SVON), PD15(EMG) Active LOW 제어, LOW=ON/정지, HIGH=OFF/정상 | `Relay_Init()`, `Relay_ServoOn()`, `Relay_ServoOff()`, `Relay_Emergency()` |
| `adc_potentiometer.c` / `adc_potentiometer.h` | **절대 위치 센서** | ADC1_CH4(PA4) 0~4095 → -90°~+90° 변환, 2점 캘리브레이션 지원 | `ADC_Pot_Init()`, `ADC_Pot_GetRaw()`, `ADC_Pot_GetAngle()`, `ADC_Pot_Calibrate()` |
| `homing.c` / `homing.h` | **홈잉 (원점 설정)** | 포텐셔미터 절대 각도 읽기 → 엔코더 오프셋 설정으로 동기화 | `Homing_Init()`, `Homing_FindZero()`, `Homing_IsComplete()` |
| `constants.h` | **상수 정의** | 엔코더 PPR, 전자기어비, 각도 제한, 허용 오차 등 시스템 파라미터 정의 | 매크로 상수만 |

---

## 3. 시스템 지원 파일

| 파일 | 역할 | 핵심 동작 |
|------|------|----------|
| `syscalls.c` | 시스템 콜 | printf 등 표준 라이브러리 지원 |
| `sysmem.c` | 메모리 관리 | sbrk() 힙 메모리 할당 |
| `ethernet_communication.c` | 이더넷 통신 | (빈 파일 - 미구현) |

---

## 4. 하드웨어 연결 요약

| 주변장치 | 핀 | 기능 | 설정 |
|---------|-----|------|------|
| **TIM1 CH1** | PE9 | 펄스 출력 | PWM, PSC=215, ARR=9 |
| **TIM1 CH2** | PE11 | 방향 신호 | PWM |
| **TIM2 CH1** | PA0 | 엔코더 A상 | Encoder Mode TI12 |
| **TIM2 CH2** | PA1 | 엔코더 B상 | Encoder Mode TI12 |
| **ADC1 CH4** | PA4 | 포텐셔미터 | 12bit, 3cycle |
| **USART3 TX** | PD8 | 디버그 TX | 115200bps |
| **USART3 RX** | PD9 | 디버그 RX | 115200bps |
| **GPIO** | PD14 | SVON 릴레이 | Output, Active LOW |
| **GPIO** | PD15 | EMG 릴레이 | Output, Active LOW |
| **GPIO** | PB0/7/14 | LED (LD1/2/3) | Output |

---

## 5. 실행 흐름도

```
main()
  │
  ├─ HAL_Init()                    → SysTick 1ms 시작
  ├─ SystemClock_Config()          → 180MHz PLL 설정
  │
  ├─ MX_GPIO_Init()                → 모든 GPIO 핀 설정
  ├─ MX_USART3_UART_Init()         → 디버그 UART
  ├─ MX_ADC1_Init()                → 포텐셔미터 ADC
  ├─ MX_TIM1_Init()                → PWM 타이머
  ├─ MX_TIM2_Init()                → 엔코더 타이머
  │
  ├─ HAL_TIM_PWM_Start(TIM1)       → PWM 출력 시작
  ├─ HAL_TIM_Encoder_Start(TIM2)   → 엔코더 읽기 시작
  │
  ├─ Relay_Init()                  → 릴레이 초기화
  ├─ PulseControl_Init()           → 펄스 제어 초기화
  ├─ EncoderReader_Init()          → 엔코더 초기화
  ├─ PositionControl_Init()        → PID 제어 초기화
  │
  └─ while(1)                      → 메인 루프
        ├─ Relay_ServoOn()         → 서보 ON
        ├─ pulse_forward(5000)     → 정방향 5000펄스
        ├─ pulse_reverse(5000)     → 역방향 5000펄스
        └─ Relay_ServoOff()        → 서보 OFF
```

---

## 6. 제어 흐름도

```
┌─────────────────────────────────────────┐
│              메인 루프                   │
│         (또는 1ms 타이머 인터럽트)        │
└──────────────────┬──────────────────────┘
                   ▼
        ┌──────────────────────┐
        │   Encoder_Reader     │ ← TIM2 카운터 읽기
        │   현재 각도 (deg)     │
        └──────────┬───────────┘
                   ▼
        ┌──────────────────────────────┐
        │   Position_Control (PID)     │
        │   오차 = 목표 - 현재          │
        │   출력 = Kp*e + Ki*∫e + Kd*de/dt
        └──────────┬───────────────────┘
                   ▼
        ┌──────────────────────┐
        │   Pulse_Control      │ → TIM1 PWM
        │   주파수/방향 설정     │
        └──────────┬───────────┘
                   ▼
        ┌──────────────────────┐
        │   서보 드라이버       │
        │   (XDL-L7SA004BAA)   │
        └──────────┬───────────┘
                   ▼
        ┌──────────────────────┐
        │   브러시리스 모터     │
        │   + 로터리 엔코더     │
        └──────────────────────┘
```

---

## 7. 핵심 변환 공식

| 변환 | 공식 | 값 |
|------|------|----|
| 엔코더 → 각도 | `카운터 × 360 / 48000` | 0.0075°/카운트 |
| 각도 → 펄스 | `각도 / 0.003` | 333.33 펄스/° |
| ADC → 전압 | `ADC × 3.3 / 4095` | 0~3.3V |
| ADC → 각도 | `min + (ADC-min_raw) × (max-min) / (max_raw-min_raw)` | -90°~+90° |

---

## 8. 디렉토리 구조

```
servo_control_baqu/
├── Core/
│   ├── Inc/                      # 헤더 파일
│   │   ├── main.h
│   │   ├── constants.h
│   │   ├── position_control.h
│   │   ├── pulse_control.h
│   │   ├── encoder_reader.h
│   │   ├── relay_control.h
│   │   ├── adc_potentiometer.h
│   │   ├── homing.h
│   │   ├── gpio.h
│   │   ├── adc.h
│   │   ├── tim.h
│   │   ├── usart.h
│   │   ├── stm32f4xx_it.h
│   │   └── stm32f4xx_hal_conf.h
│   └── Src/                      # 소스 파일
│       ├── main.c
│       ├── position_control.c
│       ├── pulse_control.c
│       ├── encoder_reader.c
│       ├── relay_control.c
│       ├── adc_potentiometer.c
│       ├── homing.c
│       ├── gpio.c
│       ├── adc.c
│       ├── tim.c
│       ├── usart.c
│       ├── stm32f4xx_it.c
│       ├── stm32f4xx_hal_msp.c
│       ├── system_stm32f4xx.c
│       ├── syscalls.c
│       ├── sysmem.c
│       └── ethernet_communication.c
├── Drivers/                      # STM32 HAL 라이브러리
├── Doc/                          # 문서
└── servo_control_baqu.ioc        # CubeMX 설정 파일
```

---

## 9. PID 제어 파라미터

| 파라미터 | 값 | 설명 |
|---------|-----|------|
| Kp | 500.0 | 비례 게인 |
| Ki | 5.0 | 적분 게인 |
| Kd | 20.0 | 미분 게인 |
| integral_limit | 1000.0 | 적분 와인드업 제한 |
| output_limit | 10000.0 | 최대 출력 주파수 (Hz) |
| POSITION_TOLERANCE | 0.5° | 안정 판단 허용 오차 |
| stable_time | 100ms | 안정 판단 시간 |

---

## 10. 안전 기능

| 기능 | 조건 | 동작 |
|------|------|------|
| 각도 제한 | 현재 각도 > ±50° | 비상 정지 |
| 오차 제한 | 오차 > 60° | 비상 정지 |
| 비상 정지 | EMG 핀 LOW | 모터 정지, PID 리셋 |
