# 서보 제어 프로젝트 수정 내역

> 작성일: 2026-01-19
> 프로젝트: servo_control_baqu
> MCU: STM32F429ZI (NUCLEO-F429ZI)

---

## 1. 개요

### 1.1 하드웨어 구성

| 구성요소 | 모델명 |
|----------|--------|
| MCU | STM32-NUCLEO-F429ZI |
| 서보드라이브 | XDL-L7SA004BAA |
| 서보모터 | XML-FBL04AMK1 |
| 전원 | 12V 배터리 → 승압컨버터 → 24V |
| 릴레이 | 제어신호용 |

### 1.2 목적

자율주행 자동차 스티어링 제어를 위한 서보모터 구동 테스트

---

## 2. 커밋 메시지 (권장)

```
fix: 서보드라이브 사양에 맞게 GPIO 극성, 엔코더, 펄스 제어 수정

- SVON/EMG Active LOW 극성 수정
- 엔코더 PPR 12000, 4체배 적용
- pulse_forward/reverse 함수 구현
- printf UART 리다이렉션 추가
- #include 경로 정규화
```

---

## 3. 전체 수정 내역

| # | 분류 | 오류/문제 | 원인 | 해결 방법 | 수정 파일 |
|---|------|-----------|------|-----------|-----------|
| 1 | GPIO 극성 | SVON이 작동 안 함 | Active LOW인데 HIGH=ON으로 구현 | `GPIO_PIN_RESET`=ON, `GPIO_PIN_SET`=OFF로 반전 | relay_control.c |
| 2 | GPIO 극성 | EMG 비상정지 로직 반대 | B접점(Active LOW)인데 반대로 구현 | `GPIO_PIN_RESET`=정지, `GPIO_PIN_SET`=정상으로 수정 | relay_control.c |
| 3 | 엔코더 | 각도 계산 부정확 | PPR=10000 잘못 설정, TIM2 미연동 | PPR=12000, 4체배=48000 count/rev, `__HAL_TIM_GET_COUNTER` 사용 | encoder_reader.c |
| 4 | 펄스 제어 | `pulse_forward/reverse` 빌드 에러 | 함수 선언/정의 없음 | `.h`에 선언, `.c`에 구현 추가 | pulse_control.h, pulse_control.c |
| 5 | 타이머 시작 | Encoder 동작 안 함 | `TIM_CHANNEL_2`로 시작 | `TIM_CHANNEL_ALL`로 수정, PWM CH2도 Start 추가 | main.c |
| 6 | printf | 디버그 출력 안 됨 | UART 리다이렉션 미구현 | `__io_putchar()` 함수 추가 (USART3) | main.c |
| 7 | #include | 컴파일 경로 오류 | `../Inc/xxx.h` 상대경로 사용 | `"xxx.h"` 형식으로 정규화 | 6개 파일 |
| 8 | 초기화 | PositionControl 미호출 | `main.c`에서 Init 누락 | `PositionControl_Init()` 호출 추가 | main.c |
| 9 | 상수 정의 | 서보드라이브 사양 미반영 | 펄스당 이동량 등 미정의 | `DEG_PER_PULSE=0.003`, `MAX_PULSE_FREQ=1MHz` 추가 | constants.h |

---

## 4. 상세 수정 내용

### 4.1 relay_control.c - GPIO 극성 수정

**문제**: 서보드라이브 SVON/EMG 신호가 Active LOW인데, 코드에서 Active HIGH로 구현

| 함수 | 수정 전 | 수정 후 |
|------|---------|---------|
| `Relay_Init()` | `SVON=RESET, EMG=RESET` | `SVON=SET(OFF), EMG=SET(정상)` |
| `Relay_ServoOn()` | `SVON=SET` | `SVON=RESET` (Active LOW) |
| `Relay_ServoOff()` | `SVON=RESET` | `SVON=SET` |
| `Relay_Emergency()` | `EMG=RESET` | `EMG=RESET` (동일, 주석 추가) |
| `Relay_EmergencyRelease()` | `EMG=SET` | `EMG=SET` (동일, 주석 추가) |

### 4.2 encoder_reader.c - 엔코더 설정

**문제**: 엔코더 PPR이 잘못 설정되어 있고, TIM2 하드웨어 카운터와 연동되지 않음

| 항목 | 수정 전 | 수정 후 |
|------|---------|---------|
| PULSE_PER_REV | 10000 | **12000** |
| 4체배 적용 | 없음 | `QUADRATURE=4` |
| COUNT_PER_REV | - | **48000** |
| DEG_PER_COUNT | 0.036도 | **0.0075도** |
| TIM2 연동 | static 변수만 사용 | `__HAL_TIM_GET_COUNTER(&htim2)` |

### 4.3 pulse_control.c - 함수 추가

**문제**: `main.c`에서 호출하는 `pulse_forward()`, `pulse_reverse()` 함수가 정의되지 않음

```c
// 추가된 함수
void pulse_forward(uint32_t count);  // SIGN=LOW, 펄스 출력 (정방향)
void pulse_reverse(uint32_t count);  // SIGN=HIGH, 펄스 출력 (역방향)
```

### 4.4 main.c - 타이머 시작 및 초기화 수정

**문제**: 엔코더 타이머 채널 설정 오류, PWM CH2 미시작, PositionControl 초기화 누락

| 항목 | 수정 전 | 수정 후 |
|------|---------|---------|
| PWM CH1 | `HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_1)` | 동일 |
| PWM CH2 | 없음 | `HAL_TIM_PWM_Start(&htim1, TIM_CHANNEL_2)` 추가 |
| Encoder | `TIM_CHANNEL_2` | `TIM_CHANNEL_ALL` |
| PositionControl | 없음 | `PositionControl_Init()` 추가 |
| printf | 없음 | `__io_putchar()` 구현 |

### 4.5 #include 경로 수정 (6개 파일)

**문제**: 상대 경로 `../Inc/xxx.h` 사용으로 빌드 환경에 따라 오류 발생

| 파일 | 수정 전 | 수정 후 |
|------|---------|---------|
| relay_control.c | `#include "../Inc/main.h"` | `#include "main.h"` |
| encoder_reader.c | `#include "../Inc/encoder_reader.h"` | `#include "encoder_reader.h"` |
| pulse_control.c | `#include "../Inc/pulse_control.h"` | `#include "pulse_control.h"` |
| position_control.c | `#include "../Inc/position_control.h"` | `#include "position_control.h"` |
| homing.c | `#include "../Inc/homing.h"` | `#include "homing.h"` |
| adc_potentiometer.c | `#include "../Inc/xxx.h"` | `#include "main.h"`, `#include "adc.h"` |

### 4.6 constants.h - 상수 추가

**문제**: 서보드라이브 사양(펄스당 이동량, 최대 주파수 등)이 정의되지 않음

| 상수 | 값 | 설명 |
|------|----|------|
| `ENCODER_QUADRATURE` | 4 | TIM2 4체배 |
| `ENCODER_COUNT_PER_REV` | 48000 | 12000 × 4 |
| `DEG_PER_PULSE` | 0.003f | 서보드라이브 전자기어비 |
| `PULSE_PER_DEG` | 333.33 | 1도당 펄스 수 |
| `MAX_PULSE_FREQ` | 1000000 | 1MHz |
| `MIN_PULSE_WIDTH_US` | 0.5f | 최소 펄스 폭 |

---

## 5. 수정된 파일 목록

| 파일 경로 | 수정 유형 |
|-----------|-----------|
| `Core/Src/relay_control.c` | 로직 수정 |
| `Core/Src/encoder_reader.c` | 설정값 + TIM2 연동 |
| `Core/Src/pulse_control.c` | 함수 추가 |
| `Core/Inc/pulse_control.h` | 함수 선언 추가 |
| `Core/Src/main.c` | 초기화 + printf |
| `Core/Inc/constants.h` | 상수 추가 |
| `Core/Src/position_control.c` | include 경로 |
| `Core/Src/homing.c` | include 경로 |
| `Core/Src/adc_potentiometer.c` | include 경로 |

---

## 6. 서보드라이브 사양 정리

### 6.1 XDL-L7SA004BAA (서보드라이브)

| 항목 | 값 |
|------|-----|
| PULS 입력 주파수 | 0 ~ 1MHz |
| PULS 신호 타입 | 라인드라이버 |
| PULS 펄스 폭 | 0.5us 이상 |
| SIGN 신호 극성 | HIGH = CCW (역방향) |
| SVON 신호 극성 | Active LOW |
| EMG 신호 극성 | Active LOW (B접점) |
| PULS/SIGN 입력 전압 | 5V |
| 펄스당 이동량 | 0.003도 |

### 6.2 XML-FBL04AMK1 (서보모터 엔코더)

| 항목 | 값 |
|------|-----|
| 엔코더 분해능 | 12000 PPR |
| 엔코더 출력 타입 | A/B/Z 차동 (라인드라이버) |
| 엔코더 출력 전압 | 5V |
| 엔코더 최대 주파수 | 25MHz |

### 6.3 배선 연결

| MCU 핀 | 신호 | 서보드라이브 핀 |
|--------|------|-----------------|
| PE9 (TIM1_CH1) | PULS+ | CN1-1 |
| PE11 (TIM1_CH2) | SIGN+ | CN1-3 |
| PD14 | SVON | CN1-13 |
| PD15 | EMG | CN1-14 |
| PA0 (TIM2_CH1) | ENC A상 | CN2-44 |
| PA1 (TIM2_CH2) | ENC B상 | CN2-46 |
| GND | 공통 GND | CN1-41 |

---

## 7. 테스트 체크리스트

- [ ] UART 터미널 연결 (115200 baud)
- [ ] 전원 ON → "Servo Start!" 메시지 확인
- [ ] 서보 ON/OFF 동작 확인
- [ ] 펄스 출력 → 모터 회전 확인
- [ ] 엔코더 값 변화 확인

---

## 8. 주의사항

| 항목 | 주의 |
|------|------|
| 전압 레벨 | MCU 3.3V → 서보드라이브 5V 입력, 라인 드라이버 필요 |
| 전원 시퀀스 | 1. 24V 전원 ON → 2. EMG 해제 → 3. SVON ON |
| 비상정지 | EMG = LOW 시 즉시 모터 정지 |

---

## 9. 추가 수정 (빌드 오류 해결)

### 9.1 오류 원인 및 해결

| # | 파일 | 오류 | 원인 | 해결 방법 |
|---|------|------|------|-----------|
| 10 | **adc.c** | 중복 include로 재정의 오류 | `stm32f4xx_hal.h` 등 불필요한 include 추가됨 | 불필요한 include 제거, `adc.h`와 `main.h`만 유지 |
| 11 | **main.h** | `SVON_PIN` 재정의 오류 | CubeMX가 `SVON_PIN_Pin` 생성, USER CODE에서 `SVON_PIN` 중복 정의 | `SVON_PIN_CTRL`, `EMG_PIN_CTRL`로 이름 변경 |
| 12 | **relay_control.c** | 핀 이름 참조 오류 | main.h 변경에 따른 핀 이름 불일치 | `SVON_PIN` → `SVON_PIN_CTRL`, `EMG_PIN` → `EMG_PIN_CTRL` |

### 9.2 adc.c 수정

**문제**: 불필요한 include로 인한 재정의 오류

```c
// 수정 전 (오류 발생)
#include "adc.h"
#include "main.h"
#include "gpio.h"
#include "stm32f4xx_hal.h"
#include "stm32f4xx_hal_adc.h"
#include "stm32f4xx_hal_gpio.h"

// 수정 후
#include "adc.h"
#include "main.h"
```

### 9.3 main.h 수정

**문제**: CubeMX 자동 생성 이름과 USER CODE 이름 충돌

| CubeMX 자동 생성 | USER CODE 원래 | USER CODE 수정 후 |
|------------------|----------------|-------------------|
| `SVON_PIN_Pin` | `SVON_PIN` | `SVON_PIN_CTRL` |
| `SVON_PIN_GPIO_Port` | `SVON_PORT` | `SVON_PORT` (동일) |
| `EMG_PIN_Pin` | `EMG_PIN` | `EMG_PIN_CTRL` |
| `EMG_PIN_GPIO_Port` | `EMG_PORT` | `EMG_PORT` (동일) |

**수정된 main.h USER CODE 영역:**
```c
/* USER CODE BEGIN Private defines */

// Servo control pins (CubeMX 정의 사용)
// SVON: PD14 -> SVON_PIN_Pin, SVON_PIN_GPIO_Port
// EMG:  PD15 -> EMG_PIN_Pin, EMG_PIN_GPIO_Port
#define SVON_PORT SVON_PIN_GPIO_Port
#define SVON_PIN_CTRL SVON_PIN_Pin
#define EMG_PORT EMG_PIN_GPIO_Port
#define EMG_PIN_CTRL EMG_PIN_Pin

/* USER CODE END Private defines */
```

### 9.4 relay_control.c 수정

**문제**: main.h에서 핀 이름이 변경되어 참조 오류

| 함수 | 수정 전 | 수정 후 |
|------|---------|---------|
| `Relay_Init()` | `SVON_PIN`, `EMG_PIN` | `SVON_PIN_CTRL`, `EMG_PIN_CTRL` |
| `Relay_ServoOn()` | `SVON_PIN` | `SVON_PIN_CTRL` |
| `Relay_ServoOff()` | `SVON_PIN` | `SVON_PIN_CTRL` |
| `Relay_Emergency()` | `EMG_PIN` | `EMG_PIN_CTRL` |
| `Relay_EmergencyRelease()` | `EMG_PIN` | `EMG_PIN_CTRL` |

### 9.5 추가 수정된 파일 목록

| 파일 경로 | 수정 유형 |
|-----------|-----------|
| `Core/Src/adc.c` | 불필요한 include 제거 |
| `Core/Inc/main.h` | 핀 이름 충돌 해결 |
| `Core/Src/relay_control.c` | 핀 이름 변경 적용 |

---

## 10. 전체 수정 파일 최종 목록

| # | 파일 경로 | 수정 내용 |
|---|-----------|-----------|
| 1 | `Core/Src/relay_control.c` | Active LOW 극성 + 핀 이름 변경 |
| 2 | `Core/Src/encoder_reader.c` | PPR 12000 + TIM2 연동 |
| 3 | `Core/Src/pulse_control.c` | `pulse_forward/reverse` 구현 |
| 4 | `Core/Inc/pulse_control.h` | 함수 선언 추가 |
| 5 | `Core/Src/main.c` | 타이머 시작 + 초기화 + printf |
| 6 | `Core/Inc/main.h` | 핀 이름 충돌 해결 |
| 7 | `Core/Inc/constants.h` | 서보드라이브 상수 추가 |
| 8 | `Core/Src/adc.c` | 불필요한 include 제거 |
| 9 | `Core/Src/position_control.c` | include 경로 수정 |
| 10 | `Core/Src/homing.c` | include 경로 수정 |
| 11 | `Core/Src/adc_potentiometer.c` | include 경로 수정 |
